<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Turniej — LM / MŚ / ME</title>
  <style>
    :root{
      --bg1:#0b1230; --bg2:#2a145a; /* default UCL */
      --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.12);
      --text:#ecf0ff; --sub:#b8c0ff;
      --accent:#8f5bff; --accent2:#b18cff;
      --ok:#2dd4bf; --bad:#f87171;
      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --r:18px; --rs:12px; --t:170ms; --e:cubic-bezier(.2,.7,.2,1);
    }
    /* Themes */
    .theme-ucl{ --bg1:#0b1230; --bg2:#2a145a; --accent:#8f5bff; --accent2:#b18cff }
    .theme-wc{ --bg1:#061b12; --bg2:#103226; --accent:#22c55e; --accent2:#16a34a }
    .theme-euro{ --bg1:#0a1b33; --bg2:#0c355f; --accent:#60a5fa; --accent2:#38bdf8 }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial;
      background:
        radial-gradient(1000px 700px at 90% -10%, rgba(255,255,255,.07), transparent 60%),
        radial-gradient(900px 600px at -10% 10%, rgba(255,255,255,.04), transparent 60%),
        linear-gradient(160deg,var(--bg1),var(--bg2));
      min-height:100svh;
    }
    .stars{position:fixed; inset:0; pointer-events:none; opacity:.35; background-image:
      radial-gradient(1px 1px at 12% 20%, rgba(255,255,255,.35), transparent 60%),
      radial-gradient(1px 1px at 35% 80%, rgba(255,255,255,.25), transparent 60%),
      radial-gradient(1px 1px at 62% 34%, rgba(255,255,255,.3), transparent 60%),
      radial-gradient(1px 1px at 82% 60%, rgba(255,255,255,.25), transparent 60%);
    }
    .app{max-width:980px; margin:0 auto; padding:22px}
    header{display:flex; align-items:center; gap:12px}
    .title{font-weight:800; font-size:clamp(22px,4.5vw,36px); letter-spacing:.2px}

    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); padding:16px}
    .grid{display:grid; gap:16px}
    .two{grid-template-columns:1fr}
    @media(min-width:720px){.two{grid-template-columns:1fr 1fr}}

    button{appearance:none; border:0; cursor:pointer; color:white; font-weight:700; border-radius:14px; padding:13px 16px; display:inline-flex; gap:10px; align-items:center; transition:transform var(--t) var(--e), filter var(--t) var(--e), background var(--t) var(--e)}
    .btn{background:linear-gradient(180deg,var(--accent),var(--accent2)); box-shadow:0 10px 22px rgba(0,0,0,.28)}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.sec{background:transparent; border:1px solid var(--line)}
    .btn.danger{background:linear-gradient(180deg,#ff6470,#f23c64)}
    .btn:focus-visible{outline:3px solid #fff; outline-offset:2px}

    .stage{margin-top:18px}

    .modebar{display:flex; gap:10px; flex-wrap:wrap}
    .modebtn{background:transparent; border:1px solid var(--line); color:var(--text); padding:10px 12px; border-radius:12px; font-weight:700}
    .modebtn[aria-pressed="true"]{background:linear-gradient(180deg,var(--accent),var(--accent2)); border-color:transparent}

    .match{display:grid; grid-template-columns:1fr auto 1fr; gap:10px; align-items:center}
    .team{border:1px solid var(--line); background:rgba(0,0,0,.25); border-radius:var(--rs); padding:10px}
    .team .name{display:flex; align-items:center; gap:10px}
    .crest{inline-size:28px; block-size:28px; border-radius:50%; background:linear-gradient(180deg,#253469,#1a1f3b); display:grid; place-items:center; font-size:12px; font-weight:800; color:#cfe1ff; border:1px solid rgba(255,255,255,.18); overflow:hidden}
    .crest img{width:100%; height:100%; object-fit:cover; display:block}
    .vs{font-weight:900; color:var(--sub); text-align:center}

    .scoreline{display:flex; align-items:flex-end; justify-content:center; gap:8px; margin-top:10px}
    .score input{width:74px; text-align:center; font-size:20px; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06); color:#fff}
    .score input:focus-visible{outline:3px solid var(--accent)}

    .confirm{display:flex; justify-content:flex-end; gap:10px; margin-top:10px}
    .status{margin-top:6px; color:var(--sub); font-size:14px}
    .win{border-color:rgba(45,212,191,.55)!important; box-shadow:0 0 0 2px rgba(45,212,191,.28) inset}
    .lead{outline:2px solid rgba(45,212,191,.35)}

    [hidden]{display:none!important}

    /* modal */
    .backdrop{position:fixed; inset:0; background:rgba(5,10,25,.7); display:grid; place-items:center; z-index:100}
    .modal{width:min(560px,calc(100vw - 32px)); background:var(--card); border:1px solid var(--line); border-radius:16px; padding:18px; box-shadow:var(--shadow)}
    .modal h3{margin:0 0 12px 0}
    .modal .opts{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:560px){.modal .opts{grid-template-columns:1fr 1fr}}

    /* table */
    table{width:100%; border-collapse:collapse; border:1px solid var(--line); background:rgba(255,255,255,.04); border-radius:14px; overflow:hidden}
    th,td{padding:10px 12px}
    thead th{color:var(--sub); font-size:13px; cursor:pointer}
    tbody tr:nth-child(even){background:rgba(255,255,255,.03)}
    .sortable::after{content:" \25B4\25BE"; opacity:.45; font-size:10px; margin-left:6px}

    /* confetti */
    .confetti{position:fixed; inset:0; pointer-events:none; z-index:200}
    .piece{position:absolute; width:8px; height:14px; border-radius:2px}
    @keyframes fall{to{transform:translateY(110vh) rotate(540deg)}}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body class="theme-ucl">
  <div class="stars" aria-hidden="true"></div>
  <div class="app">
    <header>
      <svg width="36" height="36" viewBox="0 0 64 64" aria-hidden="true"><defs><linearGradient id="g" x1="0" y1="0" x2="64" y2="64"><stop stop-color="#8f5bff"/><stop offset="1" stop-color="#b18cff"/></linearGradient></defs><circle cx="32" cy="32" r="30" stroke="url(#g)" stroke-width="3" fill="none"/><path d="M16 36c8 0 14-12 16-12s8 12 16 12" stroke="url(#g)" stroke-width="3" fill="none"/></svg>
      <div class="title" id="appTitle">Liga Mistrzów</div>
    </header>

    <div id="live" class="sr-only" aria-live="polite"></div>

    <!-- START -->
    <main id="v-start" class="stage">
      <div class="card" style="display:flex;flex-direction:column;gap:14px;align-items:center;justify-content:center;min-height:160px">
        <div class="modebar" role="group" aria-label="Wybierz turniej">
          <button class="modebtn" id="mode-ucl" aria-pressed="true">Liga Mistrzów</button>
          <button class="modebtn" id="mode-wc" aria-pressed="false">Mistrzostwa Świata</button>
          <button class="modebtn" id="mode-euro" aria-pressed="false">Mistrzostwa Europy</button>
        </div>
        <button id="btn-draw" class="btn" type="button" style="margin-top:6px">
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 3v4H3v2h6V3H7Zm10 0h-2v6h6V7h-4V3ZM7 17H3v2h6v-6H7v4Zm12 0v-4h-2v6h6v-2h-4Z" fill="currentColor"/></svg>
          Losuj półfinały
        </button>
      </div>
    </main>

    <!-- SEMIS -->
    <section id="v-semis" class="stage" hidden>
      <div class="grid two" id="semis-grid"></div>
      <div style="display:flex;justify-content:space-between;margin-top:10px">
        <button class="btn sec" id="back-to-start" type="button">Wstecz</button>
        <button class="btn" id="go-third" type="button" disabled>Dalej</button>
      </div>
    </section>

    <!-- THIRD -->
    <section id="v-third" class="stage" hidden>
      <div class="card" id="third-card"></div>
      <div style="display:flex;justify-content:space-between;margin-top:10px">
        <button class="btn sec" id="back-to-semis" type="button">Wstecz</button>
        <button class="btn" id="go-final" type="button" disabled>Dalej</button>
      </div>
    </section>

    <!-- FINAL -->
    <section id="v-final" class="stage" hidden>
      <div class="card" id="final-card"></div>
      <div style="display:flex;justify-content:space-between;margin-top:10px">
        <button class="btn sec" id="back-to-third" type="button">Wstecz</button>
        <button class="btn" id="go-summary" type="button" disabled>Pokaż podsumowanie</button>
      </div>
    </section>

    <!-- SUMMARY -->
    <section id="v-summary" class="stage" hidden>
      <div class="card">
        <div id="summary-table"></div>
        <div id="results-list" style="margin-top:12px"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <button id="btn-copy" class="btn sec" type="button">Kopiuj wyniki</button>
          <button id="btn-redraw" class="btn" type="button">Losuj ponownie</button>
          <button id="btn-reset" class="btn danger" type="button">Reset turnieju</button>
        </div>
      </div>
    </section>

    <div id="modal-root" hidden></div>
    <div id="confetti" class="confetti" aria-hidden="true"></div>
  </div>

  <script>
  (()=>{
    'use strict';

    /** ===================== Data ===================== */
    const TEAMS_UCL = [
      "Real Madrid","Manchester City","Bayern Munich","Paris Saint-Germain","Liverpool","Inter Milan","Borussia Dortmund","RB Leipzig","Barcelona","Bayer Leverkusen","Atlético Madrid","Atalanta","Juventus","Benfica","Arsenal","Club Brugge","Shakhtar Donetsk","Milan","Feyenoord","Sporting CP","PSV Eindhoven","Dinamo Zagreb","Red Bull Salzburg","Lille","Red Star Belgrade","Young Boys","Celtic","Slovan Bratislava","Monaco","Sparta Prague","Aston Villa","Bologna","Girona","VfB Stuttgart","Sturm Graz","Brest"
    ];

    const TEAMS_WC = [
      "Katar","Ekwador","Senegal","Holandia","Anglia","Iran","USA","Walia","Argentyna","Arabia Saudyjska","Meksyk","Polska","Francja","Australia","Dania","Tunezja","Hiszpania","Kostaryka","Niemcy","Japonia","Belgia","Kanada","Maroko","Chorwacja","Brazylia","Serbia","Szwajcaria","Kamerun","Portugalia","Ghana","Urugwaj","Korea Południowa"
    ];

    const TEAMS_EURO = [
      "Niemcy","Szkocja","Węgry","Szwajcaria","Hiszpania","Chorwacja","Włochy","Albania","Słowenia","Dania","Serbia","Anglia","Polska","Holandia","Austria","Francja","Belgia","Słowacja","Rumunia","Ukraina","Turcja","Gruzja","Portugalia","Czechy"
    ];

    // Mapping club => official domain for Clearbit logos
    const CLUB_DOMAIN = {
      "Real Madrid":"realmadrid.com",
      "Manchester City":"mancity.com",
      "Bayern Munich":"fcbayern.com",
      "Paris Saint-Germain":"psg.fr",
      "Liverpool":"liverpoolfc.com",
      "Inter Milan":"inter.it",
      "Borussia Dortmund":"bvb.de",
      "RB Leipzig":"rbleipzig.com",
      "Barcelona":"fcbarcelona.com",
      "Bayer Leverkusen":"bayer04.de",
      "Atlético Madrid":"atleticodemadrid.com",
      "Atalanta":"atalanta.it",
      "Juventus":"juventus.com",
      "Benfica":"slbenfica.pt",
      "Arsenal":"arsenal.com",
      "Club Brugge":"clubbrugge.be",
      "Shakhtar Donetsk":"shakhtar.com",
      "Milan":"acmilan.com",
      "Feyenoord":"feyenoord.nl",
      "Sporting CP":"sporting.pt",
      "PSV Eindhoven":"psv.nl",
      "Dinamo Zagreb":"gnkdinamo.hr",
      "Red Bull Salzburg":"redbullsalzburg.at",
      "Lille":"losc.fr",
      "Red Star Belgrade":"crvenazvezdafk.com",
      "Young Boys":"bscyb.ch",
      "Celtic":"celticfc.com",
      "Slovan Bratislava":"skslovan.com",
      "Monaco":"asmonaco.com",
      "Sparta Prague":"sparta.cz",
      "Aston Villa":"avfc.co.uk",
      "Bologna":"bolognafc.it",
      "Girona":"gironafc.cat",
      "VfB Stuttgart":"vfb.de",
      "Sturm Graz":"sksturm.at",
      "Brest":"stadebrestois29.fr",
    };

    // Country name (PL) -> code for flags
    const FLAG_CODE = {
      // World Cup set
      "Katar":"qa","Ekwador":"ec","Senegal":"sn","Holandia":"nl","Anglia":"gb-eng","Iran":"ir","USA":"us","Walia":"gb-wls","Argentyna":"ar","Arabia Saudyjska":"sa","Meksyk":"mx","Polska":"pl","Francja":"fr","Australia":"au","Dania":"dk","Tunezja":"tn","Hiszpania":"es","Kostaryka":"cr","Niemcy":"de","Japonia":"jp","Belgia":"be","Kanada":"ca","Maroko":"ma","Chorwacja":"hr","Brazylia":"br","Serbia":"rs","Szwajcaria":"ch","Kamerun":"cm","Portugalia":"pt","Ghana":"gh","Urugwaj":"uy","Korea Południowa":"kr",
      // Euro set
      "Szkocja":"gb-sct","Węgry":"hu","Włochy":"it","Albania":"al","Słowenia":"si","Austria":"at","Słowacja":"sk","Rumunia":"ro","Ukraina":"ua","Turcja":"tr","Gruzja":"ge","Czechy":"cz"
    };

    // Modes
    const MODES = {
      ucl: { key:'ucl', name:'Liga Mistrzów', theme:'theme-ucl', teams: TEAMS_UCL, badge: clubLogo },
      wc: { key:'wc', name:'Mistrzostwa Świata', theme:'theme-wc', teams: TEAMS_WC, badge: countryFlag },
      euro: { key:'euro', name:'Mistrzostwa Europy', theme:'theme-euro', teams: TEAMS_EURO, badge: countryFlag },
    };

    const $ = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));

    const els = {
      start: $('#v-start'), semis: $('#v-semis'), third: $('#v-third'), final: $('#v-final'), summary: $('#v-summary'),
      semisGrid: $('#semis-grid'), thirdCard: $('#third-card'), finalCard: $('#final-card'),
      btnDraw: $('#btn-draw'), backStart: $('#back-to-start'), goThird: $('#go-third'),
      backSemis: $('#back-to-semis'), goFinal: $('#go-final'), backThird: $('#back-to-third'), goSummary: $('#go-summary'),
      summaryTable: $('#summary-table'), resultsList: $('#results-list'),
      btnCopy: $('#btn-copy'), btnRedraw: $('#btn-redraw'), btnReset: $('#btn-reset'),
      modalRoot: $('#modal-root'), confetti: $('#confetti'), live: $('#live'),
      appTitle: $('#appTitle'),
      modeUcl: $('#mode-ucl'), modeWc: $('#mode-wc'), modeEuro: $('#mode-euro'),
    };

    const STORAGE = 'ucl-multi-v1';

    let state = {
      stage:'start',
      mode:'ucl',
      teams:[],
      matches:{ sf1:empty(), sf2:empty(), third:empty(), final:empty() }
    };

    function empty(){ return {a:'',b:'',ga:null,gb:null,winner:null,loser:null,pens:false}; }

    function save(){ try{ localStorage.setItem(STORAGE, JSON.stringify(state)); }catch{} }
    function load(){ try{ const r=localStorage.getItem(STORAGE); if(r){ state = JSON.parse(r); } }catch{} }

    /** ===================== Utils ===================== */
    function rngInt(n){ if(crypto?.getRandomValues){const u=new Uint32Array(1);crypto.getRandomValues(u);return u[0]%n;} return Math.floor(Math.random()*n); }
    function shuffle(a){ a=a.slice(); for(let i=a.length-1;i>0;i--){ const j=rngInt(i+1); [a[i],a[j]]=[a[j],a[i]];} return a; }
    function drawFour(list){ const set=new Set(); while(set.size<4){ set.add(rngInt(list.length)); } return Array.from(set).map(i=>list[i]); }
    function ehtml(s){ return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
    const nz = v => v==null? '' : String(v);

    function setStage(s){ state.stage=s; save(); render(); }
    function setMode(key){ state.mode=key; save(); applyTheme(); updateModeButtons(); updateTitle(); }

    function applyTheme(){
      document.body.classList.remove('theme-ucl','theme-wc','theme-euro');
      document.body.classList.add(MODES[state.mode].theme);
    }
    function updateModeButtons(){
      const is = (id)=> (id===state.mode).toString();
      els.modeUcl.setAttribute('aria-pressed', is('ucl'));
      els.modeWc.setAttribute('aria-pressed', is('wc'));
      els.modeEuro.setAttribute('aria-pressed', is('euro'));
    }

    function stageSuffix(){
      switch(state.stage){
        case 'semis': return ' — Półfinały';
        case 'third': return ' — Mecz o 3. miejsce';
        case 'final': return ' — Finał';
        case 'summary': return ' — Podsumowanie';
        default: return '';
      }
    }
    function updateTitle(){
      els.appTitle.textContent = MODES[state.mode].name + stageSuffix();
    }

    function ensurePairings(){
      const {sf1,sf2} = state.matches;
      if(sf1.a && sf2.a){
        if(sf1.winner && sf2.winner){
          state.matches.final.a = sf1.winner; state.matches.final.b = sf2.winner;
          state.matches.third.a = sf1.loser;  state.matches.third.b = sf2.loser;
        } else {
          state.matches.final = {...empty()}; state.matches.third = {...empty()};
        }
      }
      save();
    }

    /** ===================== Badges ===================== */
    function clubLogo(name){
      const domain = CLUB_DOMAIN[name];
      if(!domain) return null;
      return `https://logo.clearbit.com/${domain}?size=80`;
    }
    function countryFlag(name){
      const code = FLAG_CODE[name];
      if(!code) return null;
      if(code.startsWith('gb-')){ // subdivisions (England, Wales, Scotland)
        return `https://hatscripts.github.io/circle-flags/flags/${code}.svg`;
      }
      return `https://flagcdn.com/${code}.svg`;
    }

    function badgeHtml(name){
      const src = MODES[state.mode].badge(name);
      const initials = name.split(/\s+/).slice(0,2).map(w=>w[0]).join('').toUpperCase();
      return `<div class="crest">${src? `<img alt="${ehtml(name)}" src="${src}" onerror="this.remove()">` : ''}<span>${src? '' : ehtml(initials)}</span></div>`;
    }

    /** ===================== Rendering ===================== */
    function render(){
      applyTheme(); updateModeButtons(); updateTitle();
      els.start.hidden = state.stage!=='start';
      els.semis.hidden = state.stage!=='semis';
      els.third.hidden = state.stage!=='third';
      els.final.hidden = state.stage!=='final';
      els.summary.hidden = state.stage!=='summary';

      if(state.stage==='semis') renderSemis();
      if(state.stage==='third') { ensurePairings(); renderThird(); }
      if(state.stage==='final') { ensurePairings(); renderFinal(); }
      if(state.stage==='summary') renderSummary();
    }

    function matchCard(key){
      const m = state.matches[key];
      const idA = `${key}-ga`, idB = `${key}-gb`;
      const aLead = (m.ga!=null && m.gb!=null && m.ga>m.gb);
      const bLead = (m.ga!=null && m.gb!=null && m.gb>m.ga);
      const kTag = m.pens? ' <span class="status">(k)</span>' : '';
      const status = (m.ga!=null && m.gb!=null)? `${ehtml(m.a)} ${m.ga}\u2013${m.gb} ${ehtml(m.b)}${kTag} ${m.winner? `\u2014 zwycięzca: <strong>${ehtml(m.winner)}</strong>` : ''}` : '';

      const wrap = document.createElement('div');
      wrap.className='card';
      wrap.innerHTML = `
        <div class="match">
          <div class="team ${aLead?'lead':''} ${m.winner===m.a?'win':''}">
            <div class="name">${badgeHtml(m.a)}<strong>${ehtml(m.a)}</strong></div>
          </div>
          <div class="vs">VS</div>
          <div class="team ${bLead?'lead':''} ${m.winner===m.b?'win':''}">
            <div class="name">${badgeHtml(m.b)}<strong>${ehtml(m.b)}</strong></div>
          </div>
        </div>
        <div class="scoreline">
          <div class="score"><input id="${idA}" inputmode="numeric" pattern="\\d*" type="number" min="0" step="1" value="${nz(m.ga)}" aria-label="Gole ${ehtml(m.a)}"></div>
          <strong style="opacity:.75">:</strong>
          <div class="score"><input id="${idB}" inputmode="numeric" pattern="\\d*" type="number" min="0" step="1" value="${nz(m.gb)}" aria-label="Gole ${ehtml(m.b)}"></div>
        </div>
        <div class="confirm">
          <button class="btn sec" type="button" id="clear">Wyczyść</button>
          <button class="btn" type="button" id="confirm" disabled>Zatwierdź wynik</button>
        </div>
        <div class="status" id="status">${status}</div>
      `;

      const inA = $('#'+idA, wrap); const inB = $('#'+idB, wrap);
      const btnConfirm = $('#confirm', wrap); const btnClear = $('#clear', wrap);

      const validate = ()=>{
        sanitize(inA); sanitize(inB);
        const va = parseInt(inA.value,10); const vb = parseInt(inB.value,10);
        const ok = Number.isInteger(va) && va>=0 && Number.isInteger(vb) && vb>=0;
        btnConfirm.disabled = !ok;
        const teamsEls = wrap.querySelectorAll('.team');
        teamsEls.forEach(t=> t?.classList?.remove('lead'));
        if(ok){
          if(va>vb && teamsEls[0]) teamsEls[0].classList.add('lead');
          else if(vb>va && teamsEls[1]) teamsEls[1].classList.add('lead');
        }
      };

      const commit = ()=>{
        const va = toInt(inA.value); const vb = toInt(inB.value); if(va==null||vb==null) return;
        if(va===vb){
          choosePens(m.a, m.b).then(winner=>{
            if(!winner) return; // cancelled
            const loser = (winner===m.a)? m.b : m.a;
            state.matches[key] = { ...m, ga:va, gb:vb, pens:true, winner, loser };
            save(); ensurePairings(); rerenderSelf(); updateNav();
          });
        } else {
          const winner = va>vb? m.a : m.b; const loser = va>vb? m.b : m.a;
          state.matches[key] = { ...m, ga:va, gb:vb, pens:false, winner, loser };
          save(); ensurePairings(); rerenderSelf(); updateNav();
        }
      };

      function rerenderSelf(){
        if(key==='third') renderThird(); else if(key==='final') renderFinal(); else renderSemis();
      }

      inA.addEventListener('input', validate); inB.addEventListener('input', validate);
      inA.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); inB.focus(); } });
      inB.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); !btnConfirm.disabled && commit(); } });
      btnConfirm.addEventListener('click', commit);
      btnClear.addEventListener('click', ()=>{ state.matches[key] = { ...m, ga:null, gb:null, winner:null, loser:null, pens:false }; save(); ensurePairings(); rerenderSelf(); updateNav(); });

      validate();
      return wrap;
    }

    function renderSemis(){
      els.semisGrid.innerHTML='';
      els.semisGrid.appendChild(matchCard('sf1'));
      els.semisGrid.appendChild(matchCard('sf2'));
      updateNav();
    }
    function renderThird(){
      els.thirdCard.innerHTML='';
      els.thirdCard.appendChild(matchCard('third'));
      updateNav();
    }
    function renderFinal(){
      els.finalCard.innerHTML='';
      els.finalCard.appendChild(matchCard('final'));
      updateNav();
    }

    function updateNav(){
      els.goThird.disabled = !(state.matches.sf1.winner && state.matches.sf2.winner);
      els.goFinal.disabled = !state.matches.third.winner;
      els.goSummary.disabled = !state.matches.final.winner;
    }

    /** ===================== Summary ===================== */
    function computeStats(){
      const teams = state.teams.slice();
      const map={}; teams.forEach(t=> map[t]={team:t,matches:0,gf:0,ga:0,gd:0,place:null});
      const add=m=>{ if(!m.a||!m.b) return; map[m.a].matches++; map[m.b].matches++; map[m.a].gf+=m.ga||0; map[m.a].ga+=m.gb||0; map[m.b].gf+=m.gb||0; map[m.b].ga+=m.ga||0; };
      ['sf1','sf2','third','final'].forEach(k=>add(state.matches[k]));
      if(state.matches.final.winner){ map[state.matches.final.winner].place=1; map[state.matches.final.loser].place=2; }
      if(state.matches.third.winner){ map[state.matches.third.winner].place=3; map[state.matches.third.loser].place=4; }
      Object.values(map).forEach(r=> r.gd=r.gf-r.ga);
      return Object.values(map).sort((a,b)=>(a.place??99)-(b.place??99));
    }

    function buildTable(rows){
      const wrap=document.createElement('div');
      const table=document.createElement('table');
      table.innerHTML=`<thead><tr>
        <th class="sortable" data-k="team">Drużyna</th>
        <th class="sortable" data-k="gf">Gole +</th>
        <th class="sortable" data-k="ga">Gole −</th>
        <th class="sortable" data-k="gd">Bilans</th>
        <th>Miejsce</th>
      </tr></thead>
      <tbody>${rows.map(r=>`<tr><td>${ehtml(r.team)}</td><td>${r.gf}</td><td>${r.ga}</td><td>${r.gd}</td><td>${r.place??''}</td></tr>`).join('')}</tbody>`;
      wrap.appendChild(table);
      const tbody=table.querySelector('tbody'); let dir=1,last=null;
      table.querySelectorAll('th.sortable').forEach(th=> th.addEventListener('click',()=>{
        const k=th.dataset.k; dir = last===k? -dir : 1; last=k; const sorted=rows.slice().sort((a,b)=> typeof a[k]==='string'? a[k].localeCompare(b[k])*dir : (a[k]-b[k])*dir );
        tbody.innerHTML=sorted.map(r=>`<tr><td>${ehtml(r.team)}</td><td>${r.gf}</td><td>${r.ga}</td><td>${r.gd}</td><td>${r.place??''}</td></tr>`).join('');
      }));
      return wrap;
    }

    function renderSummary(){
      spawnConfetti();
      const stats=computeStats();
      els.summaryTable.innerHTML=''; els.summaryTable.appendChild(buildTable(stats));
      const order=[["SF1","sf1"],["SF2","sf2"],["3. miejsce","third"],["Finał","final"]];
      els.resultsList.innerHTML = '<h3 style="margin:6px 0">Wyniki</h3>' + order.map(([lab,k])=>{
        const m=state.matches[k]; if(!m.a) return '';
        return `<div class="status">${lab}: <strong>${ehtml(m.a)}</strong> ${m.ga}\u2013${m.gb} <strong>${ehtml(m.b)}</strong>${m.pens?' (k)':''} — zwycięzca: <strong>${ehtml(m.winner||'n/d')}</strong></div>`;
      }).join('');
    }

    /** ===================== Modal + Confetti ===================== */
    function choosePens(a,b){
      return new Promise(res=>{
        els.modalRoot.hidden=false;
        els.modalRoot.innerHTML=`<div class="backdrop" role="dialog" aria-modal="true" aria-labelledby="mt">
          <div class="modal"><h3 id="mt">Remis. Wybierz zwycięzcę <span class="status">(po karnych)</span>:</h3>
            <div class="opts">
              <button class="btn sec" id="optA" type="button">${ehtml(a)}</button>
              <button class="btn sec" id="optB" type="button">${ehtml(b)}</button>
            </div>
            <div style="display:flex;justify-content:flex-end;margin-top:12px"><button class="btn sec" id="cancel" type="button">Anuluj</button></div>
          </div></div>`;
        const root=els.modalRoot.firstElementChild; const aBtn=$('#optA',root), bBtn=$('#optB',root), cBtn=$('#cancel',root);
        const close=v=>{ els.modalRoot.hidden=true; els.modalRoot.innerHTML=''; res(v); };
        aBtn.onclick=()=>close(a); bBtn.onclick=()=>close(b); cBtn.onclick=()=>close(null);
        root.addEventListener('keydown',e=>{ if(e.key==='Escape') close(null); });
        aBtn.focus();
      });
    }

    function spawnConfetti(){
      els.confetti.innerHTML='';
      const colors=['#8f5bff','#b18cff','#2dd4bf','#ffd166','#ef476f'];
      const n=90; for(let i=0;i<n;i++){ const d=document.createElement('div'); d.className='piece'; d.style.background=colors[i%colors.length]; d.style.left=Math.random()*100+'vw'; d.style.top=(-10-Math.random()*20)+'vh'; const dur=2.2+Math.random()*1.4; d.style.animation=`fall ${dur}s linear forwards`; d.style.transform=`rotate(${Math.random()*360}deg)`; els.confetti.appendChild(d);} setTimeout(()=>els.confetti.innerHTML='',3800);
    }

    /** ===================== Input helpers ===================== */
    function sanitize(inp){ const m=(inp.value||'').match(/\d+/); inp.value = m? m[0] : ''; }
    function toInt(v){ if(!/^\d+$/.test(String(v))) return null; const n=Number(v); return Number.isInteger(n)&&n>=0? n : null; }

    /** ===================== Events ===================== */
    els.modeUcl.addEventListener('click', ()=>{ setMode('ucl'); });
    els.modeWc.addEventListener('click', ()=>{ setMode('wc'); });
    els.modeEuro.addEventListener('click', ()=>{ setMode('euro'); });

    els.btnDraw.addEventListener('click', ()=>{
      const pool = MODES[state.mode].teams;
      state.teams = shuffle(drawFour(pool));
      const [t1,t2,t3,t4]=state.teams;
      state.matches.sf1 = { ...empty(), a:t1, b:t2 };
      state.matches.sf2 = { ...empty(), a:t3, b:t4 };
      state.matches.third = empty(); state.matches.final = empty();
      setStage('semis');
      els.live.textContent = 'Wylosowano: ' + state.teams.join(', ');
    });

    els.backStart.addEventListener('click', ()=> setStage('start'));
    els.goThird.addEventListener('click', ()=>{ ensurePairings(); setStage('third'); });
    els.backSemis.addEventListener('click', ()=> setStage('semis'));
    els.goFinal.addEventListener('click', ()=> setStage('final'));
    els.backThird.addEventListener('click', ()=> setStage('third'));
    els.goSummary.addEventListener('click', ()=> setStage('summary'));

    els.btnRedraw?.addEventListener('click', ()=>{ localStorage.removeItem(STORAGE); state={stage:'semis', mode:state.mode, teams:shuffle(drawFour(MODES[state.mode].teams)), matches:{sf1:empty(),sf2:empty(),third:empty(),final:empty()}}; const [t1,t2,t3,t4]=state.teams; state.matches.sf1={...empty(),a:t1,b:t2}; state.matches.sf2={...empty(),a:t3,b:t4}; render(); els.live.textContent='Wylosowano: '+state.teams.join(', '); });
    els.btnReset?.addEventListener('click', ()=>{ localStorage.removeItem(STORAGE); state={stage:'start',mode:'ucl',teams:[],matches:{sf1:empty(),sf2:empty(),third:empty(),final:empty()}}; applyTheme(); updateModeButtons(); updateTitle(); render(); });
    els.btnCopy?.addEventListener('click', async()=>{ const data={mode:state.mode,teams:state.teams,matches:state.matches,summary:computeStats()}; try{ await navigator.clipboard.writeText(JSON.stringify(data,null,2)); }catch{} });

    /** ===================== Boot + Self-tests ===================== */
    function runSelfTests(){
      try{
        // "B prowadzi" nie sypie błędem i nadaje klasę lead prawej drużynie
        const k2='__b_leads'; state.matches[k2]={...empty(),a:'A',b:'B'}; const c2=matchCard(k2); const a2=c2.querySelector('#__b_leads-ga'); const b2=c2.querySelector('#__b_leads-gb'); a2.value='0'; b2.value='3'; a2.dispatchEvent(new Event('input')); b2.dispatchEvent(new Event('input')); const t2=c2.querySelectorAll('.team'); console.assert(t2[1] && t2[1].classList.contains('lead'), 'Right should lead'); delete state.matches[k2];
        // Tytuł zmienia się wraz ze stage
        const prevStage=state.stage; const prevMode=state.mode; state.stage='semis'; state.mode='euro'; updateTitle(); console.assert(els.appTitle.textContent.includes('Półfinały'), 'Title should show Półfinały'); state.stage=prevStage; state.mode=prevMode; updateTitle();
        // W tabeli nie ma kolumny "Mecze"
        const rows=[{team:'X',matches:2,gf:3,ga:1,gd:2,place:1},{team:'Y',matches:2,gf:1,ga:3,gd:-2,place:2}]; const tbl=buildTable(rows); console.assert(!tbl.querySelector('[data-k="matches"]'), 'No matches column');
      }catch(err){ console.warn('Self-tests failed', err); }
    }

    load(); applyTheme(); updateModeButtons(); updateTitle(); render(); runSelfTests();
  })();
  </script>
</body>
</html>
